<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VPS Warrant Monitor + SQL</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body {
            background-color: #121212;
            color: #e0e0e0;
            padding: 20px;
            font-family: 'Segoe UI', sans-serif;
        }

        .card {
            background-color: #1e1e1e;
            border: 1px solid #333;
        }

        .search-box {
            background-color: #2c2c2c;
            border: 1px solid #444;
            color: white;
        }

        .search-box:focus {
            background-color: #333;
            color: white;
            border-color: #0d6efd;
            box-shadow: none;
        }

        .table-container {
            height: 80vh;
            overflow-y: auto;
        }

        .table-dark {
            background-color: #1e1e1e;
        }

        .table-hover tbody tr:hover {
            background-color: #2c2c2c;
        }

        thead th {
            position: sticky;
            top: 0;
            background-color: #252525 !important;
            z-index: 1;
            cursor: pointer;
            user-select: none;
        }

        thead th:hover {
            background-color: #333 !important;
        }

        .sort-icon {
            font-size: 0.8em;
            margin-left: 5px;
            color: #888;
        }

        .active-sort {
            color: #0d6efd;
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <div class="row mb-3 align-items-center">
            <div class="col-md-6">
                <h2 class="m-0">VPS Monitor <small class="text-muted fs-6">(with SQL Data)</small></h2>
            </div>
            <div class="col-md-4">
                <input type="text" id="searchInput" class="form-control search-box" placeholder="Filter by Symbol...">
            </div>
            <div class="col-md-2 text-end">
                <div class="badge bg-secondary p-2">Items: <span id="item-count">0</span></div>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="table-container">
                <table class="table table-dark table-striped table-sm table-hover m-0">
                    <thead>
                        <tr>
                            <th onclick="handleSort('symbol')">Symbol <i id="icon-symbol"
                                    class="bi bi-arrow-down-up sort-icon"></i></th>
                            <th onclick="handleSort('issuer')">Issuer <i id="icon-issuer"
                                    class="bi bi-arrow-down-up sort-icon"></i></th>

                            <!-- NEW COLUMN: Exercise Price -->
                            <th onclick="handleSort('exercise_price')" class="text-end text-info">Ex. Price <i
                                    id="icon-exercise_price" class="bi bi-arrow-down-up sort-icon"></i></th>

                            <th onclick="handleSort('price')" class="text-end">Price <i id="icon-price"
                                    class="bi bi-arrow-down-up sort-icon"></i></th>
                            <th onclick="handleSort('volume')" class="text-end">Vol <i id="icon-volume"
                                    class="bi bi-arrow-down-up sort-icon"></i></th>
                            <th onclick="handleSort('change')" class="text-end">Change <i id="icon-change"
                                    class="bi bi-arrow-down-up sort-icon"></i></th>
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        <!-- Data injected by JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let rawData = [];
        let config = { sortKey: 'symbol', sortAsc: true, filter: '' };

        const tableBody = document.getElementById("table-body");
        const countSpan = document.getElementById("item-count");
        const searchInput = document.getElementById("searchInput");

        const ws = new WebSocket(`ws://${window.location.host}/ws`);

        ws.onmessage = function (event) {
            const data = JSON.parse(event.data);
            if (data && data.length > 0) {
                rawData = data;
                renderTable();
            }
        };

        searchInput.addEventListener('input', (e) => {
            config.filter = e.target.value.toLowerCase();
            renderTable();
        });

        function handleSort(key) {
            if (config.sortKey === key) config.sortAsc = !config.sortAsc;
            else { config.sortKey = key; config.sortAsc = true; }
            updateSortIcons();
            renderTable();
        }

        function updateSortIcons() {
            document.querySelectorAll('.sort-icon').forEach(icon => icon.className = 'bi bi-arrow-down-up sort-icon');
            const activeIcon = document.getElementById(`icon-${config.sortKey}`);
            if (activeIcon) activeIcon.className = config.sortAsc ? 'bi bi-arrow-up active-sort sort-icon' : 'bi bi-arrow-down active-sort sort-icon';
        }

        function parseNum(str) {
            if (typeof str === 'number') return str; // Handle SQL float values
            if (!str) return 0;
            return parseFloat(str.replace(/,/g, '').replace(/%/g, '')) || 0;
        }

        function formatNumber(num) {
            // Format 15000 -> 15,000
            return num.toLocaleString('en-US');
        }

        function renderTable() {
            let processed = rawData.filter(item => {
                return item.symbol.toLowerCase().includes(config.filter) ||
                    item.issuer.toLowerCase().includes(config.filter);
            });

            processed.sort((a, b) => {
                let valA = a[config.sortKey];
                let valB = b[config.sortKey];

                // Added exercise_price to numeric sort list
                const isNumeric = ['price', 'volume', 'change', 'exercise_price'].includes(config.sortKey);

                if (isNumeric) {
                    valA = parseNum(valA);
                    valB = parseNum(valB);
                } else {
                    valA = valA ? valA.toString().toLowerCase() : "";
                    valB = valB ? valB.toString().toLowerCase() : "";
                }

                if (valA < valB) return config.sortAsc ? -1 : 1;
                if (valA > valB) return config.sortAsc ? 1 : -1;
                return 0;
            });

            countSpan.innerText = processed.length;

            let html = "";
            processed.forEach(row => {
                let changeClass = "text-white";
                if (row.change.includes("-")) changeClass = "text-danger";
                else if (row.change !== "0" && row.change !== "") changeClass = "text-success";

                // Format the SQL Exercise Price (it comes as a raw float/int)
                let exPriceDisplay = row.exercise_price ? formatNumber(row.exercise_price) : "-";

                html += `
                    <tr>
                        <td class="fw-bold text-warning">${row.symbol}</td>
                        <td>${row.issuer}</td>
                        <td class="text-end text-info fw-bold">${exPriceDisplay}</td>
                        <td class="text-end">${row.price}</td>
                        <td class="text-end">${row.volume}</td>
                        <td class="text-end ${changeClass}">${row.change}</td>
                    </tr>
                `;
            });
            tableBody.innerHTML = html;
        }
    </script>
</body>

</html>